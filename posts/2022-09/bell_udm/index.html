<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Bell HomeHub 4000 + Ubiquiti Unifi Dream Machine VPN"><meta itemprop=description content="This article is a bit more to-the-point than most others I&rsquo;ve written, and is mostly to serve as a reference point for others trying to configure a VPN server with Unifi products behind the Bell HomeHub 4000.
The HomeHub 4000 DMZ works&mldr; kinda The HomeHub 4000 doesn&rsquo;t have Bridge mode, period. This leaves users with three options:
 Find a way to use PPPoE directly (possible, but janky) Use the &ldquo;Advanced DMZ&rdquo; feature on the HomeHub 4000 (Spoilers: It doesn&rsquo;t work at all) Use the normal DMZ feature on the HomeHub 4000 and deal with double-NAT  After several days of troubleshooting I opted for option 3 from the list above."><meta itemprop=datePublished content="2022-09-10T00:00:00+00:00"><meta itemprop=dateModified content="2022-09-10T00:00:00+00:00"><meta itemprop=wordCount content="665"><meta itemprop=keywords content="unifi,tech,"><meta property="og:title" content="Bell HomeHub 4000 + Ubiquiti Unifi Dream Machine VPN"><meta property="og:description" content="This article is a bit more to-the-point than most others I&rsquo;ve written, and is mostly to serve as a reference point for others trying to configure a VPN server with Unifi products behind the Bell HomeHub 4000.
The HomeHub 4000 DMZ works&mldr; kinda The HomeHub 4000 doesn&rsquo;t have Bridge mode, period. This leaves users with three options:
 Find a way to use PPPoE directly (possible, but janky) Use the &ldquo;Advanced DMZ&rdquo; feature on the HomeHub 4000 (Spoilers: It doesn&rsquo;t work at all) Use the normal DMZ feature on the HomeHub 4000 and deal with double-NAT  After several days of troubleshooting I opted for option 3 from the list above."><meta property="og:type" content="article"><meta property="og:url" content="https://maclarel.github.io/posts/2022-09/bell_udm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bell HomeHub 4000 + Ubiquiti Unifi Dream Machine VPN"><meta name=twitter:description content="This article is a bit more to-the-point than most others I&rsquo;ve written, and is mostly to serve as a reference point for others trying to configure a VPN server with Unifi products behind the Bell HomeHub 4000.
The HomeHub 4000 DMZ works&mldr; kinda The HomeHub 4000 doesn&rsquo;t have Bridge mode, period. This leaves users with three options:
 Find a way to use PPPoE directly (possible, but janky) Use the &ldquo;Advanced DMZ&rdquo; feature on the HomeHub 4000 (Spoilers: It doesn&rsquo;t work at all) Use the normal DMZ feature on the HomeHub 4000 and deal with double-NAT  After several days of troubleshooting I opted for option 3 from the list above."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Bell HomeHub 4000 + Ubiquiti Unifi Dream Machine VPN</title><link rel=stylesheet href=https://maclarel.github.io/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://maclarel.github.io>Logan MacLaren</a></div><nav class="site-nav hide-in-mobile"><a href=https://maclarel.github.io/posts/>Blog</a></nav></div><div class="hdr-right hdr-icons"><button id=toc-btn class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3" y2="6"/><line x1="3" y1="12" x2="3" y2="12"/><line x1="3" y1="18" x2="3" y2="18"/></svg></button><span class="hdr-social hide-in-mobile"><a href=https://www.linkedin.com/in/loganmaclaren/ target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=https://github.com/maclarel target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.youtube.com/channel/UCRoQUH8UHGi18ERXjYin8AQ target=_blank rel="noopener me" title=Youtube><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78.0 00-1.94-2C18.88 4 12 4 12 4s-6.88.0-8.6.46a2.78 2.78.0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78.0 003.4 19c1.72.46 8.6.46 8.6.46s6.88.0 8.6-.46a2.78 2.78.0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.33z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://maclarel.github.io/posts/>Blog</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Sep 10, 2022</span></div><h1>Bell HomeHub 4000 + Ubiquiti Unifi Dream Machine VPN</h1></header><div class=content><p>This article is a bit more to-the-point than most others I&rsquo;ve written, and is mostly to serve as a reference point for others trying to configure a VPN server with Unifi products behind the Bell HomeHub 4000.</p><h1 id=the-homehub-4000-dmz-works-kinda>The HomeHub 4000 DMZ works&mldr; kinda<a href=#the-homehub-4000-dmz-works-kinda class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>The HomeHub 4000 doesn&rsquo;t have <code>Bridge mode</code>, period. This leaves users with three options:</p><ol><li>Find a way to use PPPoE directly (possible, but janky)</li><li>Use the &ldquo;Advanced DMZ&rdquo; feature on the HomeHub 4000 (Spoilers: It doesn&rsquo;t work <em>at all</em>)</li><li>Use the normal DMZ feature on the HomeHub 4000 and deal with double-NAT</li></ol><p>After several days of troubleshooting I opted for option 3 from the list above.</p><ul><li>The UDM doesn&rsquo;t have an SFP port, and I wasn&rsquo;t going to shell out for a media converter, so that removed option 1.</li><li>Option 2 resulted in my UDM getting the Bell public IP as expected, but under no circumstances could it send traffic. I&rsquo;ve seen some other blog/forum posts noting that it can work if you add custom routes, but this feels so far off the supported/intended path that it&rsquo;s not worth the headache to troubleshoot if things go wrong.</li><li>Option 3, at first, seemed to be totally broken, but wound up working fine&mldr;</li></ul><h1 id=the-udms-vpn-works-kinda>The UDM&rsquo;s VPN works&mldr; kinda<a href=#the-udms-vpn-works-kinda class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>When I was using bridge mode on my old connection, I happily made use of the built-in VPN solution that the UDM (and UDM Pro) line offer. No port forwarding required, no drama, and easy to handle networking for VPN clients, as well as individual credential sets.</p><p>Unfortuately for me, the Ubiquiti software <em>refuses to enable the VPN server if it detects that it&rsquo;s on a NAT&rsquo;d connection</em>. Why it does this is completely beyond me, but it will flat out refuse to work <em>despite allowing you to enable it anyway</em>.</p><p>I spent <em>days</em> troubleshooting this, thinking that the problem was the HomeHub 4000&rsquo;s &ldquo;DMZ&rdquo;, but it was&rsquo;t. The Ubiquiti software just won&rsquo;t actually accept connections even if they originate from the same LAN (ruling out any firewall/NAT issues).</p><p>Fortunately, the new <code>Teleport</code> feature does work, but that feels like more headache than it&rsquo;s worth <em>for my use case</em> and I don&rsquo;t want to be an early adopter. It&rsquo;s also not possible, currently, to customize the subnet that Teleport VPN clients land on, and they have no access to the rest of the network(s), making it completely useless to me as the whole point is to access my LAN resources while AFK.</p><h1 id=wireguard>Wireguard<a href=#wireguard class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>After wrestling with Teleport for a while, I realized I could just run my own Wireguard server. I have a finite number of devices I want to use, and having a config file/QR code to scan is much simpler than managing credentials, or needing specific one-time-use URLs, etc&mldr; I just want to get connected.</p><p>Docker and Wireguard to the rescue! Within 30 minute I was up and running - just needed to place my UDM in the &ldquo;DMZ&rdquo; of the HomeHub 4000&rsquo;s config, port forward to the configured UDP port for Wireguard&rsquo;s container on my server, and it all &ldquo;just works&rdquo;!</p><h1 id=resources>Resources<a href=#resources class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>If you&rsquo;re interested in playing around with Wireguard, the config is <a href=https://github.com/maclarel/homelab/blob/master/wireguard/docker-compose.yml>this easy</a>. I used parts from several tutorials beyond that, but <a href=https://codeopolis.com/posts/installing-wireguard-in-docker/>this one</a> is probably the most succinct.</p><p>Just run <code>docker logs</code> for your <code>wireguard</code> container and you&rsquo;ll get the QR codes for easy mobile device configuration, or hope to your configured <code>config</code> directory to pull out the <code>peer.conf</code> file(s) to use with your other systems.</p><p>These are both then trivial to use with the official Wireguard apps available for non-Linux platforms, or of course with Wireguard proper if you&rsquo;re connecting from a Linux box.</p><h1 id=back-to-normal>Back to normal<a href=#back-to-normal class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>After a few frustrating weeks, I&rsquo;m now actually working with a <em>better</em> VPN config than I had before. No hassles with it, instantaneous connection, and great bandwidth speed compared to OpenVPN.</p><p>Hopefully Bell pushes a firmware update to the HomeHub 4000 with bridge mode some day, but I&rsquo;m not holding my breath.</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://maclarel.github.io/tags/unifi>unifi</a></span><span class=tag><a href=https://maclarel.github.io/tags/tech>tech</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>665 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-09-10 00:00 +0000</p></footer></article><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents></nav></aside><div class="post-nav thin"><a class=prev-post href=https://maclarel.github.io/posts/2022-09/karabiner/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Karabiner is a game changer</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://maclarel.github.io>Logan MacLaren</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://maclarel.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://maclarel.github.io/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>